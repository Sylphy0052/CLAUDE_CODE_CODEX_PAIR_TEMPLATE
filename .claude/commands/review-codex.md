---
description: "[多角的レビュー] 指定コードをレビューします。--codex で Codex観点、--claude でClaude観点を選択。--codex 時は Bash で codex CLI を実行し、出力をレポート/差分に反映します。"
argument_hint: "[パス(複数可)] [--codex | --claude] [--fix (任意)]"
notes: |
  バージョン: 2.3（サブエージェント非依存 / Codex CLI連携）
  依存: 対象コード、pytest（--fix時の動作検証）
  出力: REVIEW / （任意）DIFF
---
# 統合コードレビューコマンド (review)

指定されたファイル/ディレクトリに対し、設計・テスト・可読性・安全性・性能の観点でレビューします。  
`--codex` を指定すると **Codex観点のレビュー/リファクタ提案**になり、Bashで `codex` CLI を実行して結果を取得します。`--claude` はClaude観点（ローカル推論のみ）です。  
`--fix` を付けると、**安全な最小修正**のみを適用してテストを実行し、成功時に確定します。

---

## 実行フロー

### 1) 前提チェック

- 引数のパス群を解決し、存在/読み取り可否を検証。
- `.claude/.flow/state.json` があれば参照（phaseやcurrent_taskの文脈補助のため）。  
- 変更規模ガード（適用時）: **ファイル≤3, 総diff±120行**（Codex時は±200行）。

### 2) 観点プリセットの選択

- `--codex` 指定: Codex観点（自動提案強化・udiff出力優先・BashでCLI呼出）。  
- `--claude` 指定: Claude観点（ローカルで所見生成・必要に応じ最小diff提案）。  
- どちらも未指定: 既定はClaude観点。

### 3) レビュー所見の生成

- 共通観点:  
  - 設計（凝集度/結合度、責務分割）  
  - テスト（境界・エラーパス、冪等性、カバレッジ観点）  
  - 可読性（命名、一貫性、重複、レイアウト）  
  - 安全性（例外、入力検証、スレッド/IO境界）  
  - 性能（計測前提の助言、アルゴリズムの漸近的傾向）

#### A. Claude観点（--claude、デフォルト）

- ローカル解析で所見を `重大/警告/提案` に分類し、修正例（必要時）を最小diffで提示。

#### B. Codex観点（--codex）

1. **プロンプト構築**（対象コード要約、改善方針、ユニットテスト前提、udiff希望を明示）
2. **Bashで codex CLI 実行**（擬似例）:

   - ```
     PROMPT_FILE=$(mktemp)
     OUT_FILE=$(mktemp)
     echo "$CODEX_PROMPT" > "$PROMPT_FILE"
     codex --mode review --in "$PROMPT_FILE" > "$OUT_FILE" 2>&1 || true

   - ```

3. **出力の取り込み**  
   - 所見本文を抽出して `## REVIEW` に整形。  
   - udiffが含まれていれば `## DIFF` として分離。udiffが無い場合は本文内の修正例から**安全に抽出**して最小diffを合成。

### 4) （任意）最小修正の適用（--fix）

- `## DIFF` がある場合のみ適用対象。  
- 適用後に `pytest -q` を実行し、成功時に確定・失敗時はロールバック。

---

## 出力フォーマット（厳守）

---

## REVIEW

<重大/警告/提案の所見。根拠となる関数/行番号への言及を含む。Codex時は「[Codex]」タグ付きで要約を先頭に付与。>
---

## DIFF

<任意: 安全な最小修正の unified diff（存在する場合のみ）>
---

---

## エラーハンドリング

- `--codex` 指定かつ `codex` コマンド未検出 → Claude観点にフォールバック（警告を REVIEW 先頭に追記）。  
- Codex出力が長大/非構造 → 所見は採用、修正は**適用せず**提案のみ提示。  
- `--fix` でテスト失敗 → ロールバックし、失敗ログを追記して終了。

---

## 使用例

- Claude観点のレビュー（提案のみ）

  - ```
    /review src/ --claude

  - ```

- Codex観点のレビュー＆最小修正適用

  - ```
    /review src/utils.py --codex --fix

  - ```
