---
description: "[TDDサイクル連続実行] 一つのタスクが完了するまで、または指定ステップ数だけ flow-next を自動で繰り返します。"
argument_hint: "[--steps <数>] [--codex (任意)]"
notes: |
  バージョン: 1.1（詳細化・単独実行設計への準拠）
  互換性: v1.0 と同等の入出力/挙動を維持（停止条件・進捗表示・最終報告）
  依存: 内部的に flow-next の処理内容を逐次実行（--codex はそのまま引き継ぎ）
---
# Flow: TDDサイクル連続実行コマンド (flow-run)

このコマンドは、TDDの 1 ステップ実行（flow-next 相当）を自動反復し、**タスク完了**または**指定ステップ数の到達**まで進めます。デフォルトでは「現在タスクの完了」（Red→Green→Refactor の 1 サイクル完了）まで実行します。

## 振る舞いの詳細

### 1) 停止条件の決定

- `--steps <数>` が **指定されている場合**:
  - 反復回数の上限を `<数>` に固定します（例: `--steps 2` なら 2 回で停止）。
- `--steps` が **未指定（デフォルト）** の場合:
  - 停止条件は「現在のタスクが完了すること」。
  - セーフティとして **最大 5 ステップ** の上限を設け、無限ループや異常遷移を防止します。

### 2) 反復実行ループ

停止条件を満たすまで、以下を 1 サイクルとして繰り返します。

1. **進捗表示**
   - `実行中... (現在 N ステップ目, Phase: <red|green|refactor>)` の形式で現在フェーズと回数を通知。
   - 直前サイクルの結果（テストの pass/fail、適用差分の有無）を短く要約。

2. **flow-next 相当の処理を内部実行**
   - 現在の `phase` と `current_task` を読み取り、該当フェーズの段取り（Red→Green→Refactorのいずれか）を実行。
   - `--codex` オプションが付いている場合は、実装/レビュー段で Codex 観点のロジックに切替（適用可否は実行環境に依存）。
   - 実行の副産物（差分・テストログ・状態更新）は **flow-next と同等**の体裁で生成・適用されます。

3. **停止条件のチェック**
   - 直後の `state.json` と `tasks.md` を評価し、
     - ① 指定ステップ数に到達、または
     - ② `current_task` が完了（次タスクへ遷移 or 残タスクなし）
     - ③ エラー／異常（テスト恒久失敗、差分規模超過など）
     のいずれかでループを終了します。

### 3) 最終報告

- 例: `flow-run が正常に完了しました。合計 N ステップを実行しました。`
- 最終状態（phase / current_task / 残タスク数）の要約を併記。
- 必要に応じて「次アクション」（例: `未完了タスクがあるため /flow-next を継続実行してください`）を提示。

## 失敗時の扱い（代表例）

- **テストが恒久的に失敗**: 直近の差分を保持したまま停止し、失敗テスト/ログの要約を出力して終了。
- **差分規模の安全上限を超過**: そのサイクルの適用を中断して停止（次サイクルへは進まない）。
- **状態不整合（state.json 不在など）**: エラーメッセージを示して直ちに中断（`/flow-init` を案内）。

## オプション

- `--steps <数>`: 反復回数を明示的に指定（上限 5 以上も可だが、推奨は 5 以下）。
- `--codex`: 実装/レビュー観点を Codex 準拠に切替（実環境が対応している場合のみ有効）。

## 想定される入出力（概要）

- **入力**: コマンド引数（`--steps`, `--codex`）、および作業ツリー上の `.claude/.flow/state.json`, `tasks.md`
- **出力**: 各ステップの進捗表示、最終サマリ（必要に応じて直近の diff/テスト結果は flow-next 側の出力として記録）

## 実装メモ（互換ポリシー）

- 本コマンドは、**元の仕様**（停止条件・flow-next の内部呼び出し・`--codex` 引き継ぎ・最終報告）をそのまま踏襲しつつ、単独実行設計（サブエージェント非依存）に適合できるよう詳細化しています。
- 内部の各サイクルは flow-next と同等の I/O を発生させるため、既存のワークフローやレビュー保存の仕組みと互換です。
