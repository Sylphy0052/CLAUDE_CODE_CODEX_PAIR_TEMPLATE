---
description: |
  [TDDサイクル実行] 現在のタスクをRed→Green→Refactorのサイクルで1ステップ進めます。--codexオプションで実装AIを選択できます。
argument_hint: "[--codex (任意)]"
notes: |
  バージョン: 1.0
  状態管理: @state-manager
  テスト担当: @test-writer
  実装担当: @implementer (デフォルト), @codex-implementer (オプション)
  レビュー担当: @code-reviewer (デフォルト), @codex-reviewer (オプション)
---
# Flow: TDDサイクル実行コマンド (flow-next)

このコマンドは、現在のプロジェクトの状態（フェーズとタスク）に基づき、テスト駆動開発（TDD）のサイクルを正確に1ステップ進めます。

## 使用例

```bash
# デフォルトのClaudeエージェントを使って、次のステップを実行
/flow-next

# Codexエージェントを使って、次のステップを実行
/flow-next --codex
```

---

## 実行フロー

### ステップ1: 現在の状態を取得 (by @state-manager)

まず、`@state-manager`を呼び出して、現在の`phase`と`current_task`（最初の未完了タスク）を取得します。

@state-manager

- **Operation:** get_current_state
- **Details:** 現在のフェーズとカレントタスク、そしてそのタスクの受入基準を報告してください。

もし未完了のタスクが存在しない場合は、処理を中断し、「全てのタスクが完了しています。」と報告してください。

### ステップ2: フェーズに応じた処理を実行

取得した現在の`phase`に応じて、以下のいずれかの処理ブロックを実行します。

---

#### 🟩 もし、現在のフェーズが "red" なら... (失敗するテストを作成)

**目的:** これから実装する機能が、まだ存在しないことを証明する「失敗するテスト」を作成します。
**担当エージェント:** `@test-writer`

**進捗報告:**
「Phase: Red. 失敗するテストを作成します...」

@test-writer を呼び出し、現在のタスクの受入基準を満たすテストコードを生成させます。
`@test-writer`

- **Phase:** red
- **Current Task:** (ステップ1で取得したタスク名)
- **Acceptance Criteria:** (ステップ1で取得した受入基準)

テストが期待通りに**失敗**したら、**ステップ3**に進みます。
もしテストが成功してしまった場合は、処理を中断し、「エラー: Redフェーズでテストが成功してしまいました。テストの設計を見直してください。」と報告してください。

---

#### 🟩 もし、現在のフェーズが "green" なら... (テストをパスさせる実装)

**目的:** 現在失敗しているテストを、最もシンプルな方法でパスさせます。
**担当エージェント:** `--codex`オプションの有無で切り替えます。

**進捗報告:**
「Phase: Green. テストをパスさせるための最小限の実装を行います...」

- **もし `--codex` オプションが引数に含まれている場合:**
    `@codex-implementer` を呼び出します。
- **そうでなければ（デフォルト）:**
    `@implementer` を呼び出します。

呼び出すエージェントに、失敗しているテストをパスさせるための実装を指示します。
`@(選択されたimplementer)`

- **Phase:** green
- **Current Task:** (ステップ1で取得したタスク名)
- **Failing Test:** (失敗しているテストの情報)

実装後、テストが**成功**したら、**ステップ3**に進みます。
もしテストがまだ失敗する場合は、処理を中断し、「エラー: Greenフェーズでテストをパスさせることができませんでした。実装を見直してください。」と報告してください。

---

#### 🟩 もし、現在のフェーズが "refactor" なら... (コード品質の向上)

**目的:** テストが成功している状態を維持しながら、コードの品質を向上させます。
**担当エージェント:** `--codex`オプションの有無で切り替えます。

**進捗報告:**
「Phase: Refactor. コードの品質を向上させます...」

- **もし `--codex` オプションが引数に含まれている場合:**
    `@codex-reviewer` を呼び出します。
- **そうでなければ（デフォルト）:**
    `@code-reviewer` を呼び出します。

呼び出すエージェントに、コードのリファクタリングを指示します。
`@(選択されたreviewer)`

- **Phase:** refactor
- **Code to Refactor:** (リファクタリング対象のコード)
- **Relevant Tests:** (関連するテストファイル)

リファクタリング後もテストが**成功**し続けていることを確認したら、**ステップ3**に進みます。

---

### ステップ3: 状態を更新 (by @state-manager)

実行したフェーズに応じて、`@state-manager`を呼び出してプロジェクトの状態を次のステップに進めます。

- **"red"フェーズが完了した場合:**
    `phase`を`green`に更新します。
- **"green"フェーズが完了した場合:**
    `phase`を`refactor`に更新します。
- **"refactor"フェーズが完了した場合:**
    現在のタスクを完了状態にし、`phase`を次のタスクのために`red`に戻します。

`@state-manager`

- **Operation:** (update_phase または complete_task)
- **Details:** (具体的な更新内容)

### ステップ4: 最終報告

全ての処理が完了したことを報告し、最後に`@state-manager`を呼び出して、更新後のプロジェクトの状態を表示してください。

@state-manager

- **Operation:** status
- **Details:** 現在の状態を要約して報告してください。
