---
description: |
  [TDDサイクル実行] 現在のタスクをRed→Green→Refactorのサイクルで1ステップ進めます。--codexオプションで実装AIを選択できます。
argument_hint: "[--codex (任意)]"
notes: |
  バージョン: 1.0
  状態管理: @state-manager
  テスト担当: @test-writer
  実装担当: @implementer (デフォルト), @codex-implementer (オプション)
  レビュー担当: @code-reviewer (デフォルト), @codex-reviewer (オプション)
---
# Flow: TDDサイクル実行コマンド (flow-next)

このコマンドは、現在のプロジェクトの状態（フェーズとタスク）に基づき、テスト駆動開発（TDD）のサイクルを正確に1ステップ進めます。

## 使用例

```bash

# デフォルトのClaudeエージェントを使って、次のステップを実行

/flow-next

# Codexエージェントを使って、次のステップを実行

/flow-next --codex
```

---

## 実行フロー

### ステップ1: 現在の状態を取得 (by @state-manager)

まず、`@state-manager`を呼び出して、現在の`phase`と`current_task`を取得します。もし未完了のタスクが存在しない場合は、処理を中断します。

### ステップ2: フェーズに応じた処理を実行

取得した現在の`phase`に応じて、以下のいずれかの処理ブロックを実行します。

---

#### 🟩 もし、現在のフェーズが "red" なら... (失敗するテストを作成)

- **目的:** これから実装する機能が、まだ存在しないことを証明する「失敗するテスト」を作成します。
- **担当エージェント:** `@test-writer`
- **アクション:** `@test-writer`を呼び出し、現在のタスクの受入基準を満たすテストコードを生成させます。テストが期待通りに**失敗**したら、**ステップ3**に進みます。

---

#### 🟩 もし、現在のフェーズが "green" なら... (テストをパスさせる実装)

- **目的:** 現在失敗しているテストを、最もシンプルな方法でパスさせます。
- **担当エージェント:** `--codex`オプションの有無で`@implementer`または`@codex-implementer`に切り替えます。
- **アクション:** 選択された実装エージェントを呼び出し、失敗しているテストをパスさせるための**最小限の実装**を指示します。テストが**成功**したら、**ステップ3**に進みます。

---

#### 🟩 もし、現在のフェーズが "refactor" なら... (コード品質の向上)

- **目的:** テストが成功している状態を維持しながら、コードの品質を向上させます。
- **担当エージェント:** `--codex`オプションの有無で`@code-reviewer`または`@codex-reviewer`に切り替えます。
- **アクション:** 選択されたレビューエージェントを呼び出し、コードのリファクタリングを指示します。リファクタリング後もテストが**成功**し続けていることを確認したら、**ステップ3**に進みます。

---

### ステップ3: 状態を更新 (by @state-manager)

実行したフェーズに応じて、`@state-manager`を呼び出してプロジェクトの状態を次のステップに進めます。

- **"red"完了時:** `phase`を`green`に更新します。
- **"green"完了時:** `phase`を`refactor`に更新します。
- **"refactor"完了時:** 現在のタスクを完了状態にし、`phase`を次のタスクのために`red`に戻します。

### ステップ4: 最終報告

全ての処理が完了したことを報告し、最後に`@state-manager`を呼び出して、更新後のプロジェクトの状態を表示してください。
